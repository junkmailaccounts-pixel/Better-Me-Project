<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Life Dashboard</title>
  <style>
    :root{
      color-scheme: dark;
      --bg:#0b0f17;
      --panel:#101827;
      --panel2:#0f1624;
      --text:#e6edf6;
      --muted:#9fb0c6;
      --border:#22314a;
      --good:#3ddc97;
      --warn:#f2c94c;
      --bad:#ff6b6b;
      --link:#8ab4ff;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1000px 700px at 20% 0%, rgba(138,180,255,0.12), transparent 60%),
                  radial-gradient(900px 600px at 80% 0%, rgba(61,220,151,0.08), transparent 60%),
                  var(--bg);
      color:var(--text);
      padding:24px;
    }
    a{color:var(--link)}
    .wrap{max-width:1100px;margin:0 auto}
    header{
      display:flex;gap:14px;align-items:flex-start;justify-content:space-between;
      margin-bottom:18px;
    }
    h1{margin:0;font-size:22px;letter-spacing:0.2px}
    .sub{
      margin-top:6px;color:var(--muted);font-size:13px;line-height:1.35;
    }
    .right{
      text-align:right;color:var(--muted);font-size:12px;line-height:1.4;
      max-width:380px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap:14px;
    }
    @media (max-width: 920px){
      .grid{grid-template-columns:1fr}
      .right{text-align:left}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent 120%),
                  var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .bigScore{
      display:flex;align-items:baseline;gap:10px;
    }
    .scoreNum{font-size:44px;font-weight:750;letter-spacing:0.3px}
    .scoreMeta{color:var(--muted);font-size:13px}
    .pill{
      padding:6px 10px;border:1px solid var(--border);
      border-radius:999px;font-size:12px;color:var(--muted);
      background:rgba(255,255,255,0.02);
      display:inline-flex;gap:8px;align-items:center;
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .good{background:var(--good)}
    .warn{background:var(--warn)}
    .bad{background:var(--bad)}
    .kpiGrid{
      display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px;
    }
    @media (max-width: 920px){
      .kpiGrid{grid-template-columns:1fr}
    }
    .kpi{
      background: var(--panel2);
      border:1px solid var(--border);
      border-radius: 12px;
      padding:12px;
    }
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{margin-top:6px;font-size:18px;font-weight:650}
    .kpi .tiny{margin-top:4px;color:var(--muted);font-size:12px}
    .sectionTitle{
      margin:0 0 10px 0;font-size:14px;color:var(--muted);
      letter-spacing:0.2px;text-transform:uppercase;
    }
    .barWrap{margin-top:10px}
    .bar{
      height:10px;background:#0a1220;border:1px solid var(--border);
      border-radius:999px;overflow:hidden;
    }
    .bar > div{height:100%}
    .barLegend{
      margin-top:8px;display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px;
    }
    .legendItem{display:flex;gap:8px;align-items:center}
    .mini{
      width:10px;height:10px;border-radius:3px;background:#2b3c5b;
    }
    .mini.h{background:rgba(61,220,151,0.85)}
    .mini.f{background:rgba(138,180,255,0.85)}
    .mini.c{background:rgba(242,201,76,0.95)}
    .mini.w{background:rgba(255,107,107,0.9)}
    .twoCol{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 920px){.twoCol{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left}
    th{color:var(--muted);font-weight:600}
    .muted{color:var(--muted)}
    .trendUp{color:var(--good);font-weight:650}
    .trendDown{color:var(--bad);font-weight:650}
    .trendFlat{color:var(--muted);font-weight:650}
    .nudge{
      border-left:4px solid var(--warn);
      background: rgba(242,201,76,0.06);
      padding:10px 12px;border-radius:10px;border:1px solid rgba(242,201,76,0.25);
      color:var(--text);
      line-height:1.35;
    }
    .nudge strong{font-weight:750}
    .error{
      border-left:4px solid var(--bad);
      background: rgba(255,107,107,0.06);
      padding:10px 12px;border-radius:10px;border:1px solid rgba(255,107,107,0.25);
      color:var(--text);
      line-height:1.35;
    }
    .footer{margin-top:16px;color:var(--muted);font-size:12px}
    .controls{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;
    }
    .select{
      background: var(--panel2);
      border:1px solid var(--border);
      color:var(--text);
      border-radius:10px;
      padding:8px 10px;
      font-size:12px;
    }
    .btn{
      background:rgba(255,255,255,0.03);
      border:1px solid var(--border);
      color:var(--text);
      border-radius:10px;
      padding:8px 10px;
      font-size:12px;
      cursor:pointer;
    }
    .btn:hover{background:rgba(255,255,255,0.05)}
    .surveyCard{margin-bottom:14px}
    .surveyTop{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
    .surveyTitle{margin:0;font-size:16px}
    .surveyMeta{font-size:12px;color:var(--muted)}
    .surveyQ{margin-top:12px;padding:12px;border:1px solid var(--border);border-radius:10px;background:var(--panel2)}
    .surveyLabel{font-size:14px;margin-bottom:8px}
    .surveyControls{display:flex;gap:8px;justify-content:space-between;margin-top:10px;flex-wrap:wrap}
    .surveyInput{width:100%;background:#0b1322;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:10px;font-size:14px}
    .surveyHint{font-size:12px;color:var(--muted);margin-top:6px}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Dashboard</h1>
        <div class="sub" id="subtitle">Loading data…</div>
      </div>
      <div class="right">
        <div class="controls">
          <label class="muted" for="season">Season</label>
          <select id="season" class="select">
            <option value="default">Default</option>
            <option value="family">Family heavy</option>
            <option value="health">Health heavy</option>
            <option value="build">Build mode</option>
          </select>
          <button class="btn" id="refreshBtn" type="button">Refresh</button>
        </div>
        <div style="margin-top:8px" class="muted">
          Read only view from your Google Sheet CSV.
        </div>
      </div>
    </header>

    <div class="card surveyCard">
      <div class="surveyTop">
        <div>
          <h2 class="surveyTitle">Daily check-in (10 questions)</h2>
          <div class="surveyMeta" id="surveyStatus">Answer each question in order, then submit to Google Sheet.</div>
        </div>
        <div class="controls">
          <input id="writeUrlInput" class="select" type="url" placeholder="Apps Script Web App URL (.../exec)" style="min-width:320px" />
          <button class="btn" id="saveWriteUrlBtn" type="button">Save endpoint</button>
          <button class="btn" id="surveyResetBtn" type="button">Reset</button>
        </div>
      </div>
      <div class="surveyQ">
        <div class="surveyLabel" id="surveyQuestion">Loading question...</div>
        <input id="surveyInput" class="surveyInput" type="number" />
        <div class="surveyHint" id="surveyHint"></div>
        <div class="surveyControls">
          <button class="btn" id="surveyPrevBtn" type="button">Back</button>
          <button class="btn" id="surveyNextBtn" type="button">Next</button>
          <button class="btn" id="surveySubmitBtn" type="button" style="display:none">Submit to Sheet</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row">
          <div class="bigScore">
            <div class="scoreNum" id="todayScore">--</div>
            <div class="scoreMeta">
              <div id="todayLabel">Today score</div>
              <div class="muted" id="deltaLabel">--</div>
            </div>
          </div>
          <div class="pill" id="statusPill">
            <span class="dot warn"></span>
            <span id="statusText">Loading</span>
          </div>
        </div>

        <div class="barWrap">
          <div class="bar" title="Pillar contributions to Today score">
            <div id="barInner" style="display:flex;width:100%">
              <div id="barH" style="width:25%" class="mini h"></div>
              <div id="barF" style="width:25%" class="mini f"></div>
              <div id="barC" style="width:25%" class="mini c"></div>
              <div id="barW" style="width:25%" class="mini w"></div>
            </div>
          </div>
          <div class="barLegend">
            <div class="legendItem"><span class="mini h"></span>Health <span class="muted" id="hVal">--</span></div>
            <div class="legendItem"><span class="mini f"></span>Family <span class="muted" id="fVal">--</span></div>
            <div class="legendItem"><span class="mini c"></span>Creation <span class="muted" id="cVal">--</span></div>
            <div class="legendItem"><span class="mini w"></span>Wealth <span class="muted" id="wVal">--</span></div>
          </div>
        </div>

        <div class="kpiGrid">
          <div class="kpi">
            <div class="label">Trend vs yesterday</div>
            <div class="value" id="trendArrow">--</div>
            <div class="tiny" id="trendDetail">--</div>
          </div>
          <div class="kpi">
            <div class="label">Last 7 days average</div>
            <div class="value" id="avg7">--</div>
            <div class="tiny" id="avg7Detail">--</div>
          </div>
          <div class="kpi">
            <div class="label">Warnings</div>
            <div class="value" id="warnCount">--</div>
            <div class="tiny" id="warnDetail">--</div>
          </div>
        </div>

        <div style="margin-top:14px" class="nudge" id="nudgeBox">
          <strong>Nudge:</strong> Loading…
        </div>

        <div style="margin-top:12px" class="twoCol">
          <div class="kpi">
            <div class="label">Inputs</div>
            <div class="tiny muted">Sleep, steps, deep work, spending triggers</div>
            <table style="margin-top:6px">
              <tbody id="inputsTable"></tbody>
            </table>
          </div>
          <div class="kpi">
            <div class="label">Outputs</div>
            <div class="tiny muted">Pillars and total score</div>
            <table style="margin-top:6px">
              <tbody id="outputsTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <h2 class="sectionTitle">Recent days</h2>
        <div class="muted" style="margin-bottom:10px">Most recent entries from your sheet.</div>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Score</th>
              <th>Health</th>
              <th>Family</th>
              <th>Creation</th>
              <th>Wealth</th>
            </tr>
          </thead>
          <tbody id="recentTable"></tbody>
        </table>
        <div class="footer" id="footerNote">--</div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // 1) SET YOUR CSV URL HERE
    // =========================
    // You can use either:
    // - a Google Sheets share/edit link
    // - a direct CSV/export link
    // Example format:
    // https://docs.google.com/spreadsheets/d/e/<PUB_ID>/pub?gid=<GID>&single=true&output=csv
    const CSV_URL = "https://docs.google.com/spreadsheets/d/1nNsB3nbwwgF7bPuYNoqMnc3JXng7DK0Y1Djd0SSq8zM/edit?usp=sharing";
    // Apps Script web app URL that appends POSTed JSON rows into your sheet.
    // Example: https://script.google.com/macros/s/<SCRIPT_ID>/exec
    const SHEET_WRITE_URL = "";
    const SHEET_WRITE_URL_STORAGE_KEY = "betterme.sheetWriteUrl";

    function toGoogleSheetCsvUrl(url){
      const raw = String(url || "").trim();
      if (!raw) return "";

      // Already a CSV/export endpoint.
      if (/output=csv/.test(raw) || /tqx=out:csv/.test(raw)) return raw;

      // Convert a normal sheet share/edit URL into an export URL.
      const match = raw.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      if (!match) return raw;

      let gid = "0";
      try {
        const u = new URL(raw);
        gid = u.searchParams.get("gid") || gid;
        if (u.hash) {
          const hashMatch = u.hash.match(/gid=(\d+)/);
          if (hashMatch) gid = hashMatch[1];
        }
      } catch (_) {
        const gidMatch = raw.match(/[?&#]gid=(\d+)/);
        gid = gidMatch ? gidMatch[1] : gid;
      }

      return `https://docs.google.com/spreadsheets/d/${match[1]}/export?format=csv&gid=${gid}`;
    }

    // ==========================================
    // 2) MAP YOUR SHEET COLUMN NAMES HERE
    // ==========================================
    // Update these to match your exact header names in the CSV.
    // Required:
    // - date
    // - totalScore (or we will compute weighted score if pillars exist)
    // - pillars: healthScore, familyScore, creationScore, wealthScore
    //
    // Optional inputs you mentioned:
    // - sleepHours, steps, deepWorkMinutes, impulseSpendCount
    const COL = {
      date: "Date",
      totalScore: "Total Score",
      healthScore: "Health",
      familyScore: "Family",
      creationScore: "Creation",
      wealthScore: "Wealth",
      sleepHours: "Sleep Hours",
      steps: "Steps",
      deepWorkMinutes: "Deep Work Minutes",
      impulseSpendCount: "Impulse Spend Count"
    };

    // ==========================================
    // 3) SEASONAL WEIGHTS (adjust over time)
    // ==========================================
    // These weights are used to compute a weighted total when totalScore is missing
    // OR to compute the "pillar contribution bar" even if totalScore exists.
    const WEIGHTS = {
      default: { health: 0.35, family: 0.35, creation: 0.20, wealth: 0.10 },
      family:   { health: 0.30, family: 0.45, creation: 0.15, wealth: 0.10 },
      health:   { health: 0.45, family: 0.30, creation: 0.15, wealth: 0.10 },
      build:    { health: 0.30, family: 0.30, creation: 0.30, wealth: 0.10 }
    };

    // ==========================================
    // 4) THRESHOLDS FOR WARNINGS AND NUDGES
    // ==========================================
    const THRESH = {
      lowScore: 75,
      sleepLow: 7.0,
      stepsLow: 6000,
      deepWorkLowMin: 60,
      impulseSpendHigh: 1
    };

    const $ = (id) => document.getElementById(id);

    function parseCSV(text){
      // Simple CSV parser that handles quoted fields.
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++){
        const c = text[i];
        const next = text[i+1];

        if (c === '"' && inQuotes && next === '"'){ // escaped quote
          cur += '"';
          i++;
          continue;
        }
        if (c === '"'){
          inQuotes = !inQuotes;
          continue;
        }
        if (c === ',' && !inQuotes){
          row.push(cur);
          cur = "";
          continue;
        }
        if ((c === '\n' || c === '\r') && !inQuotes){
          if (cur.length || row.length){
            row.push(cur);
            rows.push(row);
            row = [];
            cur = "";
          }
          continue;
        }
        cur += c;
      }
      if (cur.length || row.length){
        row.push(cur);
        rows.push(row);
      }
      if (rows.length === 0) return [];

      const headers = rows[0].map(h => h.trim());
      const data = [];
      for (let r = 1; r < rows.length; r++){
        const obj = {};
        for (let c = 0; c < headers.length; c++){
          obj[headers[c]] = (rows[r][c] ?? "").trim();
        }
        // Skip empty lines
        const any = Object.values(obj).some(v => v !== "");
        if (any) data.push(obj);
      }
      return data;
    }

    function cleanHeader(text){
      return String(text || "").replace(/^﻿/, "").trim();
    }

    function findColumnName(row, preferred, fallbacks = []){
      const keys = Object.keys(row || {});
      const wanted = [preferred, ...fallbacks]
        .map(cleanHeader)
        .filter(Boolean)
        .map(v => v.toLowerCase());

      for (const key of keys){
        const normalized = cleanHeader(key).toLowerCase();
        if (wanted.includes(normalized)) return key;
      }

      return null;
    }

    function valueFromRow(row, preferred, fallbacks = []){
      const key = findColumnName(row, preferred, fallbacks);
      return key ? row[key] : undefined;
    }

    function toNum(v){
      if (v === null || v === undefined) return null;
      const s = String(v).replace(/[^0-9.\-]/g,"").trim();
      if (!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    function parseDate(v){
      const raw = String(v || "").trim();
      if (!raw) return null;

      if (/^\d{4}-\d{2}-\d{2}/.test(raw)) {
        const d = new Date(raw.slice(0, 10) + "T00:00:00");
        return Number.isNaN(d.getTime()) ? null : d;
      }

      const mdy = raw.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})(?:\s+\d{1,2}:\d{2}(?::\d{2})?)?/);
      if (mdy) {
        const mm = mdy[1].padStart(2, "0");
        const dd = mdy[2].padStart(2, "0");
        const yyyy = mdy[3].length === 2 ? `20${mdy[3]}` : mdy[3];
        const d = new Date(`${yyyy}-${mm}-${dd}T00:00:00`);
        return Number.isNaN(d.getTime()) ? null : d;
      }

      const d = new Date(raw);
      return Number.isNaN(d.getTime()) ? null : d;
    }

    function fmt(n, digits=0){
      if (n === null || n === undefined || !Number.isFinite(n)) return "--";
      return n.toFixed(digits);
    }

    function trendArrow(delta){
      if (!Number.isFinite(delta)) return {txt:"--", cls:"trendFlat"};
      if (delta > 0.5) return {txt:"▲ Up", cls:"trendUp"};
      if (delta < -0.5) return {txt:"▼ Down", cls:"trendDown"};
      return {txt:"▬ Flat", cls:"trendFlat"};
    }

    function pickSeasonWeights(){
      const key = $("season").value || "default";
      return WEIGHTS[key] || WEIGHTS.default;
    }

    function computeWeightedTotal(p, w){
      if (![p.health, p.family, p.creation, p.wealth].every(x => Number.isFinite(x))) return null;

      // Support either 0-25 pillar inputs (habit scoring) or 0-100 pillar inputs.
      const maxPillar = Math.max(p.health, p.family, p.creation, p.wealth);
      const scale = maxPillar <= 25 ? 4 : 1;

      return (p.health*scale)*w.health + (p.family*scale)*w.family + (p.creation*scale)*w.creation + (p.wealth*scale)*w.wealth;
    }

    function statusForScore(score){
      if (!Number.isFinite(score)) return {label:"No data", dot:"warn"};
      if (score >= 85) return {label:"On track", dot:"good"};
      if (score >= THRESH.lowScore) return {label:"Watch it", dot:"warn"};
      return {label:"Needs attention", dot:"bad"};
    }

    function buildNudge(last3){
      // last3: most recent 3 rows
      // Priority: repeated misses in the last 2-3 days
      let misses = [];
      const recent = last3.filter(x => x);

      const sleepMiss = recent.filter(x => Number.isFinite(x.sleep) && x.sleep < THRESH.sleepLow).length;
      const stepsMiss = recent.filter(x => Number.isFinite(x.steps) && x.steps < THRESH.stepsLow).length;
      const deepMiss  = recent.filter(x => Number.isFinite(x.deep) && x.deep < THRESH.deepWorkLowMin).length;
      const spendHigh = recent.filter(x => Number.isFinite(x.impulse) && x.impulse > THRESH.impulseSpendHigh).length;
      const scoreLow  = recent.filter(x => Number.isFinite(x.score) && x.score < THRESH.lowScore).length;

      if (scoreLow >= 2) misses.push("Your score has been low for two of the last three days. Pick one lever and fix it today.");
      if (sleepMiss >= 2) misses.push("Sleep is slipping. Protect your bedtime and aim for at least " + THRESH.sleepLow + " hours.");
      if (deepMiss >= 2)  misses.push("Deep work has been light. Block 60 to 90 minutes early today.");
      if (stepsMiss >= 2) misses.push("Movement is low. Get a short walk in before lunch.");
      if (spendHigh >= 1) misses.push("Spending triggers showed up recently. Pause one day before any non essential purchase.");

      if (misses.length === 0) {
        return "You are steady. Keep the basics tight today. Sleep, a focused block, and one family connection.";
      }

      // Choose the top 2
      return misses.slice(0,2).join(" ");
    }

    function buildWarnings(row){
      const warns = [];
      if (Number.isFinite(row.score) && row.score < THRESH.lowScore) warns.push("Low score");
      if (Number.isFinite(row.sleep) && row.sleep < THRESH.sleepLow) warns.push("Low sleep");
      if (Number.isFinite(row.steps) && row.steps < THRESH.stepsLow) warns.push("Low steps");
      if (Number.isFinite(row.deep) && row.deep < THRESH.deepWorkLowMin) warns.push("Low deep work");
      if (Number.isFinite(row.impulse) && row.impulse > THRESH.impulseSpendHigh) warns.push("Impulse spend");
      return warns;
    }

    function boolNum(v){
      const n = toNum(v);
      return Number.isFinite(n) ? (n > 0 ? 1 : 0) : 0;
    }

    function pointsByBands(value, bands){
      for (const [min, pts] of bands){
        if (value >= min) return pts;
      }
      return 0;
    }

    function derivePillarsFromHabits(row){
      const sleep = toNum(valueFromRow(row, "SleepHours", ["Sleep Hours", "sleepHours"])) || 0;
      const steps = toNum(valueFromRow(row, "Steps", ["steps"])) || 0;
      const kidsMin = toNum(valueFromRow(row, "KidsMinutes", ["Kids Minutes"])) || 0;
      const deepMin = toNum(valueFromRow(row, "DeepWorkMinutes", ["Deep Work Minutes", "deepWorkMinutes"])) || 0;

      const health =
        pointsByBands(sleep, [[7, 8], [6, 6], [5, 3]]) +
        pointsByBands(steps, [[10000, 6], [7000, 4], [4000, 2]]) +
        boolNum(valueFromRow(row, "StrengthYN", ["Strength YN"])) * 4 +
        boolNum(valueFromRow(row, "ProteinYN", ["Protein YN"])) * 3 +
        boolNum(valueFromRow(row, "CaloriesYN", ["Calories YN"])) * 4;

      const family =
        pointsByBands(kidsMin, [[60, 10], [30, 7], [15, 4], [1, 2]]) +
        boolNum(valueFromRow(row, "ProactiveYN", ["Proactive YN"])) * 5 +
        boolNum(valueFromRow(row, "FollowThroughYN", ["Follow Through YN"])) * 5 +
        boolNum(valueFromRow(row, "NoEscalationYN", ["No Escalation YN"])) * 5;

      const wealth =
        boolNum(valueFromRow(row, "NoImpulseYN", ["No Impulse YN"])) * 8 +
        boolNum(valueFromRow(row, "TrackedSpendingYN", ["Tracked Spending YN"])) * 5 +
        boolNum(valueFromRow(row, "InvestYN", ["Invest YN"])) * 7 +
        boolNum(valueFromRow(row, "Skill20YN", ["Skill20 YN"])) * 5;

      const creation =
        pointsByBands(deepMin, [[120, 10], [60, 7], [30, 4], [1, 2]]) +
        boolNum(valueFromRow(row, "ShippedYN", ["Shipped YN"])) * 7 +
        boolNum(valueFromRow(row, "BuildArtifactYN", ["Build Artifact YN"])) * 5 +
        boolNum(valueFromRow(row, "TomorrowOneSentenceYN", ["Tomorrow One Sentence YN"])) * 3;

      return { health, family, creation, wealth };
    }

    function setDotClass(el, dot){
      const d = el.querySelector(".dot");
      d.classList.remove("good","warn","bad");
      d.classList.add(dot);
    }

    const SURVEY_QUESTIONS = [
      { key: "SleepHours", label: "1) How many hours did you sleep?", type: "number", step: "0.1", min: "0", max: "24", hint: "Example: 7.5" },
      { key: "Steps", label: "2) How many steps did you take today?", type: "number", step: "1", min: "0", hint: "Example: 8000" },
      { key: "KidsMinutes", label: "3) Minutes of focused time with kids?", type: "number", step: "1", min: "0" },
      { key: "DeepWorkMinutes", label: "4) Deep work minutes completed?", type: "number", step: "1", min: "0" },
      { key: "StrengthYN", label: "5) Did you do strength training? (1=yes, 0=no)", type: "number", step: "1", min: "0", max: "1" },
      { key: "ProteinYN", label: "6) Hit protein goal? (1=yes, 0=no)", type: "number", step: "1", min: "0", max: "1" },
      { key: "CaloriesYN", label: "7) Stayed within calories? (1=yes, 0=no)", type: "number", step: "1", min: "0", max: "1" },
      { key: "ProactiveYN", label: "8) Was parenting proactive? (1=yes, 0=no)", type: "number", step: "1", min: "0", max: "1" },
      { key: "NoEscalationYN", label: "9) No escalations? (1=yes, 0=no)", type: "number", step: "1", min: "0", max: "1" },
      { key: "NoImpulseYN", label: "10) No impulse spending? (1=yes, 0=no)", type: "number", step: "1", min: "0", max: "1" }
    ];

    let surveyIndex = 0;
    const surveyAnswers = {};

    function setSurveyStatus(text){
      $("surveyStatus").textContent = text;
    }

    function getSheetWriteUrl(){
      const stored = localStorage.getItem(SHEET_WRITE_URL_STORAGE_KEY) || "";
      return String(stored || SHEET_WRITE_URL || "").trim();
    }

    function setSheetWriteUrl(url){
      const normalized = String(url || "").trim();
      if (!normalized) {
        localStorage.removeItem(SHEET_WRITE_URL_STORAGE_KEY);
        return;
      }
      localStorage.setItem(SHEET_WRITE_URL_STORAGE_KEY, normalized);
    }

    function updateSurveyView(){
      const q = SURVEY_QUESTIONS[surveyIndex];
      const input = $("surveyInput");
      $("surveyQuestion").textContent = q.label;
      $("surveyHint").textContent = q.hint || `Question ${surveyIndex + 1} of ${SURVEY_QUESTIONS.length}`;

      input.type = q.type || "text";
      input.step = q.step || "1";
      input.min = q.min || "";
      input.max = q.max || "";
      input.value = surveyAnswers[q.key] ?? "";

      $("surveyPrevBtn").disabled = surveyIndex === 0;
      $("surveyNextBtn").style.display = surveyIndex === SURVEY_QUESTIONS.length - 1 ? "none" : "inline-block";
      $("surveySubmitBtn").style.display = surveyIndex === SURVEY_QUESTIONS.length - 1 ? "inline-block" : "none";
    }

    function storeCurrentAnswer(){
      const q = SURVEY_QUESTIONS[surveyIndex];
      const raw = String($("surveyInput").value || "").trim();
      if (!raw) return false;
      const n = Number(raw);
      if (!Number.isFinite(n)) return false;
      surveyAnswers[q.key] = n;
      return true;
    }

    function buildSurveyPayload(){
      return {
        Timestamp: new Date().toISOString(),
        Date: new Date().toISOString().slice(0, 10),
        SleepHours: surveyAnswers.SleepHours ?? 0,
        Steps: surveyAnswers.Steps ?? 0,
        KidsMinutes: surveyAnswers.KidsMinutes ?? 0,
        DeepWorkMinutes: surveyAnswers.DeepWorkMinutes ?? 0,
        StrengthYN: surveyAnswers.StrengthYN ?? 0,
        ProteinYN: surveyAnswers.ProteinYN ?? 0,
        CaloriesYN: surveyAnswers.CaloriesYN ?? 0,
        ProactiveYN: surveyAnswers.ProactiveYN ?? 0,
        NoEscalationYN: surveyAnswers.NoEscalationYN ?? 0,
        NoImpulseYN: surveyAnswers.NoImpulseYN ?? 0,
        FollowThroughYN: 0,
        TrackedSpendingYN: 0,
        InvestYN: 0,
        Skill20YN: 0,
        ShippedYN: 0,
        BuildArtifactYN: 0,
        TomorrowOneSentenceYN: 0
      };
    }

    async function submitSurvey(){
      if (!storeCurrentAnswer()) {
        setSurveyStatus("Enter a valid answer before submitting.");
        return;
      }
      const missing = SURVEY_QUESTIONS.filter(q => !Number.isFinite(surveyAnswers[q.key]));
      if (missing.length) {
        setSurveyStatus(`Please complete all questions. Missing: ${missing[0].label}`);
        return;
      }
      const sheetWriteUrl = getSheetWriteUrl();
      if (!sheetWriteUrl) {
        setSurveyStatus("Set your Apps Script endpoint in the 'Apps Script Web App URL' box and click Save endpoint.");
        return;
      }

      setSurveyStatus("Submitting to Google Sheet...");
      const payload = buildSurveyPayload();
      const res = await fetch(sheetWriteUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const bodyText = await res.text();
      if (!res.ok) {
        const sample = bodyText ? bodyText.slice(0, 180).replace(/\s+/g, " ") : "";
        throw new Error(`Submit failed (HTTP ${res.status}). ${sample}`.trim());
      }

      if (/^<!doctype html>/i.test(bodyText.trim())) {
        setSurveyStatus("Sheet endpoint returned HTML. Confirm you used the Apps Script /exec URL, not a page URL.");
        return;
      }

      setSurveyStatus("Saved. Refreshing dashboard...");
      await load();
      setSurveyStatus("Saved to sheet successfully.");
    }

    function wireSurvey(){
      $("surveyPrevBtn").addEventListener("click", () => {
        storeCurrentAnswer();
        surveyIndex = Math.max(0, surveyIndex - 1);
        updateSurveyView();
      });

      $("surveyNextBtn").addEventListener("click", () => {
        if (!storeCurrentAnswer()) {
          setSurveyStatus("Enter a valid answer before moving on.");
          return;
        }
        surveyIndex = Math.min(SURVEY_QUESTIONS.length - 1, surveyIndex + 1);
        updateSurveyView();
        setSurveyStatus(`Progress: ${surveyIndex + 1}/${SURVEY_QUESTIONS.length}`);
      });

      $("surveySubmitBtn").addEventListener("click", async () => {
        try {
          await submitSurvey();
        } catch (err) {
          setSurveyStatus("Error submitting survey: " + (err?.message || String(err)));
        }
      });

      $("saveWriteUrlBtn").addEventListener("click", () => {
        const url = String($("writeUrlInput").value || "").trim();
        if (!url) {
          setSheetWriteUrl("");
          setSurveyStatus("Write endpoint cleared.");
          return;
        }
        if (!/^https:\/\//i.test(url)) {
          setSurveyStatus("Endpoint must be a valid https URL.");
          return;
        }
        if (!/\/exec(?:$|[?#])/.test(url)) {
          setSurveyStatus("Use the deployed Apps Script Web App URL ending in /exec.");
          return;
        }
        setSheetWriteUrl(url);
        setSurveyStatus("Write endpoint saved.");
      });

      $("surveyResetBtn").addEventListener("click", () => {
        surveyIndex = 0;
        Object.keys(surveyAnswers).forEach(k => delete surveyAnswers[k]);
        updateSurveyView();
        setSurveyStatus("Survey reset.");
      });

      $("writeUrlInput").value = getSheetWriteUrl();
      const configuredUrl = getSheetWriteUrl();
      if (configuredUrl) {
        setSurveyStatus("Write endpoint ready. Complete all 10 questions and submit.");
      }

      $("surveyInput").addEventListener("keydown", async (event) => {
        if (event.key !== "Enter") return;
        event.preventDefault();
        if (surveyIndex < SURVEY_QUESTIONS.length - 1) {
          $("surveyNextBtn").click();
          return;
        }
        try {
          await submitSurvey();
        } catch (err) {
          setSurveyStatus("Error submitting survey: " + (err?.message || String(err)));
        }
      });

      updateSurveyView();
    }

    async function load(){
      try{
        if (!CSV_URL || CSV_URL.includes("PASTE_YOUR_CSV_URL_HERE")){
          throw new Error("CSV_URL is not set. Paste your published Google Sheets CSV link into CSV_URL.");
        }

        const csvUrl = toGoogleSheetCsvUrl(CSV_URL);
        const res = await fetch(csvUrl, { cache: "no-store" });
        if (!res.ok) throw new Error("Failed to load CSV. HTTP " + res.status);
        const text = await res.text();

        const raw = parseCSV(text);

        // Normalize rows
        const rows = raw.map(r => {
          const dateVal = valueFromRow(r, COL.date, ["Timestamp", "timestamp", "Day", "day"]);
          const d = parseDate(dateVal);
          let health = toNum(valueFromRow(r, COL.healthScore, ["HealthScore"]));
          let family = toNum(valueFromRow(r, COL.familyScore, ["FamilyScore"]));
          let creation = toNum(valueFromRow(r, COL.creationScore, ["CreationScore"]));
          let wealth = toNum(valueFromRow(r, COL.wealthScore, ["WealthScore"]));

          if (![health, family, creation, wealth].every(Number.isFinite)) {
            const derived = derivePillarsFromHabits(r);
            health = Number.isFinite(health) ? health : derived.health;
            family = Number.isFinite(family) ? family : derived.family;
            creation = Number.isFinite(creation) ? creation : derived.creation;
            wealth = Number.isFinite(wealth) ? wealth : derived.wealth;
          }
          const total = toNum(valueFromRow(r, COL.totalScore, ["Score", "Total"]));

          const sleep = toNum(valueFromRow(r, COL.sleepHours, ["SleepHours"]));
          const steps = toNum(valueFromRow(r, COL.steps));
          const deep = toNum(valueFromRow(r, COL.deepWorkMinutes, ["DeepWorkMinutes"]));
          const impulse = toNum(valueFromRow(r, COL.impulseSpendCount, ["ImpulseSpends", "Impulse"]));

          return {
            raw: r,
            date: d,
            dateText: dateVal || "",
            pillars: { health, family, creation, wealth },
            totalRaw: total,
            sleep, steps, deep, impulse
          };
        }).filter(x => x.date);

        rows.sort((a,b) => a.date - b.date);

        if (rows.length === 0) throw new Error("No dated rows found. Check your Date column mapping.");

        const w = pickSeasonWeights();

        // Build computed scores
        const computed = rows.map(x => {
          const weighted = computeWeightedTotal(x.pillars, w);
          const score = Number.isFinite(x.totalRaw) ? x.totalRaw : weighted;
          return { ...x, score, weighted };
        });

        const today = computed[computed.length - 1];
        const yesterday = computed.length >= 2 ? computed[computed.length - 2] : null;

        // Headline
        const todayScore = today.score;
        $("todayScore").textContent = fmt(todayScore, 0);

        const delta = (yesterday && Number.isFinite(yesterday.score) && Number.isFinite(todayScore))
          ? (todayScore - yesterday.score)
          : null;

        $("deltaLabel").textContent = Number.isFinite(delta) ? ( (delta>=0?"+":"") + fmt(delta,0) + " vs yesterday") : "No prior day to compare";

        const t = trendArrow(delta);
        $("trendArrow").textContent = t.txt;
        $("trendArrow").className = t.cls;
        $("trendDetail").textContent = Number.isFinite(delta) ? ("Change: " + ((delta>=0?"+":"") + fmt(delta,0))) : "--";

        // Status
        const st = statusForScore(todayScore);
        $("statusText").textContent = st.label;
        setDotClass($("statusPill"), st.dot);

        // Averages
        const last7 = computed.slice(Math.max(0, computed.length - 7));
        const avg7 = last7.map(x => x.score).filter(Number.isFinite);
        const avg7v = avg7.length ? (avg7.reduce((a,b)=>a+b,0)/avg7.length) : null;
        $("avg7").textContent = fmt(avg7v, 0);
        $("avg7Detail").textContent = avg7.length ? (avg7.length + " days") : "No data";

        // Pillar values and contribution bar
        const p = today.pillars;
        const h = p.health, f = p.family, c = p.creation, ww = p.wealth;

        $("hVal").textContent = fmt(h,0);
        $("fVal").textContent = fmt(f,0);
        $("cVal").textContent = fmt(c,0);
        $("wVal").textContent = fmt(ww,0);

        // Contribution widths use weights (not raw pillars)
        const totW = w.health + w.family + w.creation + w.wealth;
        const wh = (w.health/totW)*100;
        const wf = (w.family/totW)*100;
        const wc = (w.creation/totW)*100;
        const wwe = (w.wealth/totW)*100;
        $("barH").style.width = wh + "%";
        $("barF").style.width = wf + "%";
        $("barC").style.width = wc + "%";
        $("barW").style.width = wwe + "%";

        // Warnings
        const warnsToday = buildWarnings({ score: todayScore, sleep: today.sleep, steps: today.steps, deep: today.deep, impulse: today.impulse });
        $("warnCount").textContent = String(warnsToday.length);
        $("warnDetail").textContent = warnsToday.length ? warnsToday.join(", ") : "None";

        // Nudge based on last 3 days
        const last3 = computed.slice(Math.max(0, computed.length - 3)).reverse().map(x => ({
          score: x.score, sleep: x.sleep, steps: x.steps, deep: x.deep, impulse: x.impulse
        }));
        $("nudgeBox").innerHTML = "<strong>Nudge:</strong> " + buildNudge(last3);

        // Subtitle
        const seasonKey = $("season").value;
        const seasonName = seasonKey === "default" ? "Default weights" :
                           seasonKey === "family" ? "Family heavy weights" :
                           seasonKey === "health" ? "Health heavy weights" :
                           "Build mode weights";
        $("subtitle").textContent = "Latest entry: " + (today.dateText || today.date.toDateString()) + "  |  " + seasonName;

        // Inputs table
        const inputs = [
          ["Sleep hours", fmt(today.sleep, 1)],
          ["Steps", fmt(today.steps, 0)],
          ["Deep work minutes", fmt(today.deep, 0)],
          ["Impulse spend count", fmt(today.impulse, 0)]
        ];
        $("inputsTable").innerHTML = inputs.map(([k,v]) =>
          `<tr><td class="muted">${k}</td><td>${v}</td></tr>`
        ).join("");

        // Outputs table
        const outputs = [
          ["Total score", fmt(todayScore, 0)],
          ["Health", fmt(h, 0)],
          ["Family", fmt(f, 0)],
          ["Creation", fmt(c, 0)],
          ["Wealth", fmt(ww, 0)]
        ];
        $("outputsTable").innerHTML = outputs.map(([k,v]) =>
          `<tr><td class="muted">${k}</td><td>${v}</td></tr>`
        ).join("");

        // Recent table (last 10)
        const recent = computed.slice(Math.max(0, computed.length - 10)).reverse();
        $("recentTable").innerHTML = recent.map(x => `
          <tr>
            <td>${x.dateText || x.date.toISOString().slice(0,10)}</td>
            <td>${fmt(x.score,0)}</td>
            <td>${fmt(x.pillars.health,0)}</td>
            <td>${fmt(x.pillars.family,0)}</td>
            <td>${fmt(x.pillars.creation,0)}</td>
            <td>${fmt(x.pillars.wealth,0)}</td>
          </tr>
        `).join("");

        $("footerNote").textContent =
          "Weights in use: Health " + Math.round(w.health*100) + "%, Family " + Math.round(w.family*100) + "%, Creation " + Math.round(w.creation*100) + "%, Wealth " + Math.round(w.wealth*100) + "%.";

      } catch (err){
        $("subtitle").textContent = "Error loading data";
        const box = $("nudgeBox");
        box.className = "error";
        box.innerHTML = "<strong>Error:</strong> " + (err?.message || String(err));
        $("todayScore").textContent = "--";
        $("statusText").textContent = "Error";
        setDotClass($("statusPill"), "bad");
      }
    }

    $("season").addEventListener("change", load);
    $("refreshBtn").addEventListener("click", load);
    wireSurvey();
    load();
  </script>
</body>
</html>
